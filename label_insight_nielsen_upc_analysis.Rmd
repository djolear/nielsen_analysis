---
title: "Label Insight UPC Analysis"
author: "Daniel O'Leary"
date: "10/15/2020"
output:
  github_document:
    toc: true
    toc_depth: 5
---

# Load packages

```{r}
if (!require("pacman")) install.packages("pacman")

pacman::p_load(
  tidyverse, 
  haven,
  lubridate,
  readr
)
```


# Set path

```{r}
sinfo <- data.frame(Sys.info())
machine <- sinfo$Sys.info..[4]

machine_path <- 
  ifelse(
    machine %in% c("sussman-rp-mbpro.local", "sussman-rp-mbpro.lan"), 
    "/Users/djolear/Google Drive/", 
    "G:/My Drive/"
  )
```


# Load functions

```{r}
source(paste0(machine_path, "research/projects/niel/nielsen_analysis/bind_nielsen_to_label_insight_fn.R"))
```


# Load data

```{r}
# Set year
year = "2015"

niel_df <- bind_labels_to_purchases_fn(year)

source(paste0(machine_path, "research/projects/niel/nielsen_analysis/bind_purchases_to_products_master.R"))

panelists <-
  read_tsv(paste0("G:/Shared drives/SPL-Nielsen/Consumer_Panel_Data_2004_2017/Consumer_Panel_Data_2004_2017/nielsen_extracts/HMS/", year, "/Annual_Files/panelists_", year, ".tsv"))

```


# Analysis

## Label Insight coverage of UPC's in Nielsen dataset by Nielsen department description

### Calories

```{r}
niel_df %>% 
  count(department_descr, !is.na(calories)) %>% 
  left_join(
    niel_df %>% 
      count(department_descr) %>% 
      mutate(total = n) %>% 
      dplyr::select(-n)
  ) %>%
  filter(department_descr %in% c("DAIRY", "DELI", "DRY GROCERY", "FRESH PRODUCE", "FROZEN FOODS", "PACKAGED MEAT", NA)) %>% 
  mutate(per = n / total) %>% 
  filter(`!is.na(calories)` == TRUE) %>% 
  ggplot(aes(fct_reorder(department_descr, per), per, fill = department_descr)) +
  geom_col() +
  labs(
    x = "department description",
    y = "proportion coverage of calorie NI by label insight upc's"
  ) +
  coord_flip() +
  theme_bw()
```



### Sugar

```{r}
niel_df %>% 
  count(department_descr, !is.na(sugar)) %>% 
  left_join(
    niel_df %>% 
      count(department_descr) %>% 
      mutate(total = n) %>% 
      dplyr::select(-n)
  ) %>%
  filter(department_descr %in% c("DAIRY", "DELI", "DRY GROCERY", "FRESH PRODUCE", "FROZEN FOODS", "PACKAGED MEAT", NA)) %>% 
  mutate(per = n / total) %>% 
  filter(`!is.na(sugar)` == TRUE) %>% 
  ggplot(aes(fct_reorder(department_descr, per), per, fill = department_descr)) +
  geom_col() +
  labs(
    x = "department description",
    y = "proportion coverage of sugar NI by label insight upc's"
  ) +
  coord_flip() +
  theme_bw()
```


### Sugar

```{r}
niel_df %>% 
  count(department_descr, !is.na(add_sugars)) %>% 
  left_join(
    niel_df %>% 
      count(department_descr) %>% 
      mutate(total = n) %>% 
      dplyr::select(-n)
  ) %>%
  filter(department_descr %in% c("DAIRY", "DELI", "DRY GROCERY", "FRESH PRODUCE", "FROZEN FOODS", "PACKAGED MEAT", NA)) %>% 
  mutate(per = n / total) %>% 
  filter(`!is.na(add_sugars)` == TRUE) %>% 
  ggplot(aes(fct_reorder(department_descr, per), per, fill = department_descr)) +
  geom_col() +
  labs(
    x = "department description",
    y = "proportion coverage of add_sugars NI by label insight upc's"
  ) +
  coord_flip() +
  theme_bw()
```


### Saturated Fat

```{r}
niel_df %>% 
  count(department_descr, !is.na(saturated_fat)) %>% 
  left_join(
    niel_df %>% 
      count(department_descr) %>% 
      mutate(total = n) %>% 
      dplyr::select(-n)
  ) %>%
  filter(department_descr %in% c("DAIRY", "DELI", "DRY GROCERY", "FRESH PRODUCE", "FROZEN FOODS", "PACKAGED MEAT", NA)) %>% 
  mutate(per = n / total) %>% 
  filter(`!is.na(saturated_fat)` == TRUE) %>% 
  ggplot(aes(fct_reorder(department_descr, per), per, fill = department_descr)) +
  geom_col() +
  labs(
    x = "department description",
    y = "proportion coverage of saturated fat NI by label insight upc's"
  ) +
  coord_flip() +
  theme_bw()
```


## Does missing data vary by household demographics?

### Calories

#### Calculate the percentage of missing calorie labels per household

```{r}
# Calculate the percentage of missing calories labels per household

household_calories_upc_na <-
  niel_df %>% 
  count(household_code, !is.na(calories)) %>% 
  left_join(
    niel_df %>% 
      count(household_code) %>% 
      mutate(total = n) %>% 
      dplyr::select(-n)
  ) %>%
  mutate(per = n / total) %>% 
  filter(`!is.na(calories)` == TRUE) 


# Join to demographics

household_calories_upc_na <-
  household_calories_upc_na %>% 
  left_join(
    panelists %>% 
      mutate(household_code = Household_Cd) %>% 
      dplyr::select(
        household_code,
        Household_Income,
        Male_Head_Education,
        Female_Head_Education
      )
  )
```


#### Examine relationship with demographics

```{r}
lm1 <-
  lm(
    scale(per) ~
      scale(Household_Income),
    data = household_calories_upc_na
  )

summary(lm1)

broom::tidy(lm1) %>% 
  mutate(across(is.numeric, round, 3))

lm1 <-
  lm(
    scale(per) ~
      scale(Male_Head_Education),
    data = household_calories_upc_na
  )

summary(lm1)

broom::tidy(lm1) %>% 
  mutate(across(is.numeric, round, 3))

lm1 <-
  lm(
    scale(per) ~
      scale(Female_Head_Education),
    data = household_calories_upc_na
  )

summary(lm1)

broom::tidy(lm1) %>% 
  mutate(across(is.numeric, round, 3))
```


### Sugar

#### Calculate the percentage of missing sugar labels per household

```{r}
# Calculate the percentage of missing sugar labels per household

household_sugar_upc_na <-
  niel_df %>% 
  count(household_code, !is.na(sugar)) %>% 
  left_join(
    niel_df %>% 
      count(household_code) %>% 
      mutate(total = n) %>% 
      dplyr::select(-n)
  ) %>%
  mutate(per = n / total) %>% 
  filter(`!is.na(sugar)` == TRUE) 


# Join to demographics

household_sugar_upc_na <-
  household_sugar_upc_na %>% 
  left_join(
    panelists %>% 
      mutate(household_code = Household_Cd) %>% 
      dplyr::select(
        household_code,
        Household_Income,
        Male_Head_Education,
        Female_Head_Education
      )
  )
```


#### Examine relationship with demographics

```{r}
lm1 <-
  lm(
    scale(per) ~
      scale(Household_Income),
    data = household_sugar_upc_na
  )

summary(lm1)

broom::tidy(lm1) %>% 
  mutate(across(is.numeric, round, 3))

lm1 <-
  lm(
    scale(per) ~
      scale(Male_Head_Education),
    data = household_sugar_upc_na
  )

summary(lm1)

broom::tidy(lm1) %>% 
  mutate(across(is.numeric, round, 3))

lm1 <-
  lm(
    scale(per) ~
      scale(Female_Head_Education),
    data = household_sugar_upc_na
  )

summary(lm1)

broom::tidy(lm1) %>% 
  mutate(across(is.numeric, round, 3))
```

### Saturated Fat

#### Calculate the percentage of missing saturated fat labels per household

```{r}
# Calculate the percentage of missing saturated fat labels per household

household_saturated_fat_upc_na <-
  niel_df %>% 
  count(household_code, !is.na(saturated_fat)) %>% 
  left_join(
    niel_df %>% 
      count(household_code) %>% 
      mutate(total = n) %>% 
      dplyr::select(-n)
  ) %>%
  mutate(per = n / total) %>% 
  filter(`!is.na(saturated_fat)` == TRUE) 


# Join to demographics

household_saturated_fat_upc_na <-
  household_saturated_fat_upc_na %>% 
  left_join(
    panelists %>% 
      mutate(household_code = Household_Cd) %>% 
      dplyr::select(
        household_code,
        Household_Income,
        Male_Head_Education,
        Female_Head_Education
      )
  )
```


#### Examine relationship with demographics

```{r}
lm1 <-
  lm(
    scale(per) ~
      scale(Household_Income),
    data = household_saturated_fat_upc_na
  )

summary(lm1)

broom::tidy(lm1) %>% 
  mutate(across(is.numeric, round, 3))

lm1 <-
  lm(
    scale(per) ~
      scale(Male_Head_Education),
    data = household_saturated_fat_upc_na
  )

summary(lm1)

broom::tidy(lm1) %>% 
  mutate(across(is.numeric, round, 3))

lm1 <-
  lm(
    scale(per) ~
      scale(Female_Head_Education),
    data = household_saturated_fat_upc_na
  )

summary(lm1)

broom::tidy(lm1) %>% 
  mutate(across(is.numeric, round, 3))
```

