---
title: "Nielsen Relative Status Regression Analysis"
author: "Daniel O'Leary"
date: "4/12/2021"
output:
  github_document:
    toc: true
    toc_depth: 5
---

# Setup

## Load Packages

```{r, include = FALSE}
if (!require("pacman")) install.packages("pacman")

pacman::p_load(
  tidyverse, 
  haven,
  lme4,
  lm.beta,
  sjPlot,
  stargazer,
  broom,
  broom.mixed,
  gbm
)
```


## Load Data

```{r}
qh_calories_imputed_sc_by_household_monthly <-
  read_csv("D:/data/nielsen/calories_extracts/qfahpd_health_calories_imputed_sc_by_household_monthly/combined/qh_calories_imputed_sc_by_household_monthly.csv") %>% 
  mutate(across(c(month, year), as.factor))

qh_spend_by_household_monthly <-
  read_csv("D:/data/nielsen/spend_extracts/qfahpd_health_spend_by_household_monthly/combined/qh_spend_by_household_monthly.csv") %>% 
  mutate(across(c(month, year), as.factor))
```


# Analysis

## Outcome: % of monthly household calorie budget that goes to QFAHPD healthy categories

### Fit model

```{r}
lm1 <-
  lm(
    yes_scale ~
      income_demo_ranger_sar_scale +
      income_scale +
      Male_Head_Education_scale +
      Female_Head_Education_scale +
      Male_Head_Age_scale + 
      Female_Head_Age_scale +
      Male_Head_Employment +
      Female_Head_Employment +
      median_home_value_county_scale +
      land_area_2010_scale +
      total_pop_county_scale +
      Race +
      Marital_Status +
      household_size_scale +
      month + 
      year,
      # (1|quarter) +
      # (1 + income_demo_ranger_sar_scale|fip_code) +
      # (1 + income_scale | fips_code),
    data = 
      qh_calories_imputed_sc_by_household_monthly %>% 
      filter(year %in% c(2004:2016))
  )

summary(lm1)
regclass::VIF(lm1)
lm.beta::lm.beta(lm1)

tidy_lm1 <- tidy(lm1)
```


### Plot results

```{r}
est <- 
  tidy_lm1 %>% 
  dplyr::filter(term == "income_demo_ranger_sar_scale") %>% 
  dplyr::select(estimate)

tidy_lm1 <-
  tidy_lm1 %>% 
  mutate(
    dot_color = ifelse(estimate < 0, "red1", ifelse(estimate > 0, "dodgerblue2", NA)),
    se = std.error
  )

tidy_lm1 <-
  tidy_lm1 %>% 
  filter(
    term == "income_demo_ranger_sar_scale" |
    term == "income_scale" |
    term == "Male_Head_Education_scale" | 
    term == "Female_Head_Education_scale" 
  ) %>% 
  mutate(
    variable = 
      case_when(
        term == "income_demo_ranger_sar_scale" ~ "demographic reference \n median income",
        term == "income_scale" ~ "household income",
        term == "Male_Head_Education_scale" ~ "male head education",
        term == "Female_Head_Education_scale" ~ "female head education"
      )
  ) 

col <- as.character(tidy_lm1$dot_color)
names(col) <- as.character(tidy_lm1$dot_color)

qh_calories_monthly <-
  tidy_lm1 %>% 
  ggplot(aes(reorder(as.factor(variable), estimate), estimate)) +
  geom_point(aes(color = dot_color), size = 4) +
  geom_errorbar(aes(ymin = estimate - 2 * se, ymax = estimate + 2 * se), width = 0) + 
  scale_color_manual(values = col) +
  geom_hline(yintercept = -abs(est$estimate), linetype = "dashed", color = "red") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = abs(est$estimate), linetype = "dashed", color = "red") +
  scale_y_continuous(
    breaks = c( -0.3, -0.2, -0.1, 0, 0.1, 0.2, 0.3),
    limits = c(-0.35, 0.35)
  ) +
  labs(
    y = "standardized beta",
    x = "variable"
  ) +
  theme_bw() +
  theme(
    text = element_text(size = 17),
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"
  ) +
  coord_flip()

qh_calories_monthly

ggsave(
  "G:/My Drive/research/projects/niel/nielsen_relative_income/plots/qh_calories_monthly.png",
  qh_calories_monthly,
  width = 6,
  height = 4,
  dpi = 750
)
```


## Outcome: % of monthly household food spend that goes to QFAHPD healthy categories

### Fit model

```{r}
lm1 <-
  lm(
    yes_scale ~
      income_demo_ranger_sar_scale +
      income_scale +
      Male_Head_Education_scale +
      Female_Head_Education_scale +
      Male_Head_Age_scale + 
      Female_Head_Age_scale +
      Male_Head_Employment +
      Female_Head_Employment +
      median_home_value_county_scale +
      land_area_2010_scale +
      total_pop_county_scale +
      Race +
      Marital_Status +
      household_size_scale +
      month + 
      year,
      # (1|quarter) +
      # (1 + income_demo_ranger_sar_scale|fip_code) +
      # (1 + income_scale | fips_code),
    data = 
      qh_spend_by_household_monthly %>% 
      filter(year %in% c(2004:2016))
  )

summary(lm1)
regclass::VIF(lm1)
lm.beta::lm.beta(lm1)

tidy_lm1 <- tidy(lm1)
```


### Plot results

```{r}
est <- 
  tidy_lm1 %>% 
  dplyr::filter(term == "income_demo_ranger_sar_scale") %>% 
  dplyr::select(estimate)

tidy_lm1 <-
  tidy_lm1 %>% 
  mutate(
    dot_color = ifelse(estimate < 0, "red1", ifelse(estimate > 0, "dodgerblue2", NA)),
    se = std.error
  )

tidy_lm1 <-
  tidy_lm1 %>% 
  filter(
    term == "income_demo_ranger_sar_scale" |
    term == "income_scale" |
    term == "Male_Head_Education_scale" | 
    term == "Female_Head_Education_scale" 
  ) %>% 
  mutate(
    variable = 
      case_when(
        term == "income_demo_ranger_sar_scale" ~ "demographic reference \n median income",
        term == "income_scale" ~ "household income",
        term == "Male_Head_Education_scale" ~ "male head education",
        term == "Female_Head_Education_scale" ~ "female head education"
      )
  ) 

col <- as.character(tidy_lm1$dot_color)
names(col) <- as.character(tidy_lm1$dot_color)

qh_spend_monthly <-
  tidy_lm1 %>% 
  ggplot(aes(reorder(as.factor(variable), estimate), estimate)) +
  geom_point(aes(color = dot_color), size = 4) +
  geom_errorbar(aes(ymin = estimate - 2 * se, ymax = estimate + 2 * se), width = 0) + 
  scale_color_manual(values = col) +
  geom_hline(yintercept = -abs(est$estimate), linetype = "dashed", color = "red") +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_hline(yintercept = abs(est$estimate), linetype = "dashed", color = "red") +
  scale_y_continuous(
    breaks = c( -0.3, -0.2, -0.1, 0, 0.1, 0.2, 0.3),
    limits = c(-0.35, 0.35)
  ) +
  labs(
    y = "standardized beta",
    x = "variable"
  ) +
  theme_bw() +
  theme(
    text = element_text(size = 17),
    plot.title = element_text(hjust = 0.5),
    legend.position = "none"
  ) +
  coord_flip()

qh_calories_monthly

ggsave(
  "G:/My Drive/research/projects/niel/nielsen_relative_income/plots/qh_spend_monthly.png",
  qh_spend_monthly,
  width = 6,
  height = 4,
  dpi = 750
)
```